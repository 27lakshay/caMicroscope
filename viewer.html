<!DOCTYPE html>
<html>

<head>
	<meta name="keywords" content="camicroscope, quip" />
    <meta charset='utf-8'>
    <meta http-equiv='X-UA-Compatible' content='IE=edge'>
    <meta name='viewport' content='width=device-width, initial-scale=1'>

    <title>caMicroscope</title>
		<!-- google material icons css sheet -->
		<link href='./iconfont/material-icons.css' rel='stylesheet'/>
		<!-- css sheet -->
		<link rel='stylesheet' type='text/css' media='all' href='./css/style.css'/>

		<!-- message display bar css -->
		<link rel='stylesheet' type='text/css' media='all' href='./lib/camessage/camessage.css'/>
		<!-- toolbar css -->
		<link rel='stylesheet' type='text/css' media='all' href='./lib/toolbar/toolbar.css'/>
		<!-- zoom control css -->
 		<link rel='stylesheet' type='text/css' media='all' href='./lib/zoomcontrol/openseadragon-zoom-control.css'/>

		<!-- side menu css -->
		<link rel='stylesheet' type='text/css' media='all' href='./lib/sidemenu/sidemenu.css'/>
		<!-- layers controller css -->
		<link rel='stylesheet' type='text/css' media='all' href='./lib/layersviewer/layersviewer.css'/>

	    <!-- collapsible list css -->
	    <link rel='stylesheet' type='text/css' media='all' href='./lib/collapsiblelist/collapsiblelist.css'/>

		<!-- operation panel css -->
		<link rel='stylesheet' type='text/css' media='all' href='./lib/operationpanel/operationpanel.css'/>
		<!-- mult selector css -->
		<link rel='stylesheet' type='text/css' media='all' href='./lib/multselector/multselector.css'/>
		<!-- stylecontextmenu css -->
		<link href="./lib/simplecontextmenu/simplecontextmenu.css" rel="stylesheet" />
		<!-- message queue css -->
		<link href="./lib/messagequeue/messagequeue.css" rel="stylesheet" />

		<!-- loading cover css -->
		<link href="./lib/loading/loading.css" rel="stylesheet" />

		<!-- popup panel css -->
		<link href="./lib/popuppanel/popuppanel.css" rel="stylesheet" />
		<!-- color picker css -->
		<link href="./lib/colorpicker/color-picker.css" rel="stylesheet" />
		<!-- add pure-form css -->
		<link href="./lib/pureform/pure-form.css" rel="stylesheet" />
		<!-- add spyglass css -->
		<link href="./lib/spyglass/spyglass.css" rel="stylesheet" />
		<link href="./core/openseadragon-measurement-tool/openseadragon-measurement-tool.css" rel="stylesheet" />

		<!-- add pure-form script -->
		<script src="./lib/pureform/document-register-element.js"></script>
		<script src="./lib/pureform/pure-form.js"></script>

		<!-- open seadragon lib-->
		<script src='./lib/openseadragon/openseadragon.js' ></script>
		<script src='./lib/openseadragon-imaginghelper.min.js'></script>
		<script src='./lib/openseadragon-scalebar.js'></script>
		<script src='./lib/openseadragonzoomlevels.js'></script>

		<!-- util.js -->
		<script src = './js/util.js' type='text/javascript'></script>
		<!-- message display js -->
		<script src='./lib/camessage/camessage.js'></script>
		<!-- toolbar js -->
		<script src='./lib/toolbar/toolbar.js'></script>
		<!-- zoom ctrl js -->
		<!--
		<script src='/lib/zoomcontrol/zoomcontrol.js'></script> -->
		<!-- sidemenu js -->
		<script src='./lib/sidemenu/sidemenu.js'></script>
	    <!-- collapsible list js -->
	    <script src='./lib/collapsiblelist/collapsiblelist.js'></script>
		<!-- layers controller js -->
		<script src='./lib/layersviewer/layersviewer.js'></script>

		<!-- operation panel js -->
		<script src='./lib/operationpanel/operationpanel.js'></script>

		<!-- loading cover js -->
		<script src='./lib/loading/loading.js'></script>

		<!-- color picker js -->
		<script src='./lib/colorpicker/color-picker.js'></script>

		<!-- stylecontextmenu js -->
		<script src='./lib/simplecontextmenu/simplecontextmenu.js'></script>
		<!-- popup panel js -->
		<script src='./lib/popuppanel/popuppanel.js'></script>
		<!-- message queue js -->
		<script src='./lib/messagequeue/messagequeue.js'></script>
		<!-- mult selector js -->
		<script src='./lib/multselector/multselector.js'></script>

		<script src="./lib/sortable/Sortable.js"></script>

		<!-- spyglass -->
		<script src="./lib/spyglass/spyglass.js"></script>

		<!-- State Helper -->
		<script src="./lib/StatesHelper.js"></script>
		<!-- core (package/ext) libs -->
		<script src='./core/DrawHelper.js'></script>
		<script src="./core/simplify.js"></script>
		<script src="./core/paths.js"></script>
		<script src='./core/Store.js'></script>
		<script src='./core/CaMic.js'></script>
		<script src="./core/openseadragon-canvas-draw-overlay.js"></script>
		<script src="./core/openseadragon-overlays-manage.js"></script>
		<script src="./core/openseadragon-measurement-tool/openseadragon-measurement-tool.js"></script>
		<script src="./lib/zoomcontrol/openseadragon-zoom-control.js"></script>

		<!-- init data -->
		<!-- <script src='/js/init.js'></script> -->
		<!-- ods js -->
		<script src='./js/uicallbacks.js'></script>
		<script src='./js/dataloaders.js'></script>
		<script src='./js/init.js'></script>

	</head>
	<body>
        <!-- message-->
        <div id='cames' style='z-index:600'></div>

        <!-- toolbar -->
        <div id='ca_tools'></div>

        <!-- main viewer -->
        <div id='main_viewer' class='main'></div>
        <div id='secondary' class='none'>
            <div id='mult_selector' class='none'></div>
            <div id='minor_viewer' class='none'></div>
        </div>
        <!-- zoom control -->
        <div id='zctrl'></div>

        <!-- side menu for apps-->
        <div id='side_apps' style='z-index:600'></div>

        <!-- side menu for layers-->
        <div id='side_layers' style='z-index:600'></div>

        <!-- collapsible list -- annotation and analytics -->
        <div id='collapsiblelist' style='z-index:600'></div>

        <!-- overlayer manager -->
        <div id='overlayers' style='z-index:600'></div>

	</body>
	<script type="text/javascript">
		Loading.open(document.body, 'CaMicroscope is initializing...');
		// get slide id from url
		$D.params = getUrlVars();

		// load if we have at least one slide query element
		if($D.params && $D.params.slideId){
			// normal initialization starts
			document.addEventListener('DOMContentLoaded', initialize);
		}
		else if ($D.params && ($D.params.slide || $D.params.location)){
			let STORE = new Store()
			STORE.findSlide($D.params.slide, $D.params.location).then(x=>{
				if(x.length == 0){
					redirect($D.pages.table,'No Slide Found. Redirecting to Table.');
				} else {
					newParams = $D.params
					delete newParams.data
					delete newParams.slide
					delete newParams.location
					newParams.slideId = x[0]['_id']['$oid']
					newUrl = window.location.href.split("?")[0] + "?" + objToParamStr(newParams)
					window.location.href = newUrl
				}
			}).catch(e=>{
				console.warn(e)
				redirect($D.pages.table,'Redirecting to Table.');
			})
			// find the associated slideID
			// open viewer with that slideID
		}
		else {
			redirect($D.pages.table,'Slide is undefined. Redirecting to Table.');
		}

		// get states parameters
		if($D.params.states){
			$D.params.states = StatesHelper.decodeStates($D.params.states);
		}
	</script>
	<script src="./dist/packages.js"></script>
</html>
