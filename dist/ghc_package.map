{"version":3,"sources":["GHCHelpers.js","ghc_package.js"],"names":["GHCHelpers","project","location","dataset","store","viewer","COLUMN_POSITION_TAG","COLUMNS_TAG","FUNCTIONAL_GROUP_SEQUENCE_TAG","PLANE_POSITION_SEQUENCE_TAG","ROW_POSITION_TAG","ROWS_TAG","SERIES_INSTANCE_UID_TAG","SOP_INSTANCE_UID_TAG","STUDY_INSTANCE_UID_TAG","TOTAL_PIXEL_MATRIX_COLUMNS_TAG","TOTAL_PIXEL_MATRIX_ROWS_TAG","updatedDicomUrl","cookiename","cookiestring","RegExp","exec","document","cookie","token","decodeURIComponent","toString","replace","path","study","baseUrl","seriesPath","ajax","toDicomWebQIDOUrl","jqXHR","responseJSON","error","code","message","series","instancesPath","Value","instances","maxWidthPx","maxHeightPx","tileWidthPx","tileHeightPx","levelWidths","Set","i","length","w","Number","add","h","sortedLevelWidths","Array","from","values","sort","a","b","countLevels","size","pyramidMeta","calculatePyramidMeta","tileSource","level","row","col","x","params","toDicomWebWADOUrl","SOPInstanceUID","FrameNumber","bind","ts_event","CustomEvent","detail","dispatchEvent","log","open","err","alert","dicomInstances","widthToLevelMap","sopInstanceUID","frameMeta","j","frameNumber","y","key","indexOf","CaMic","prototype","loadImg","func","urlParams","URLSearchParams","window","search","ghc_params","JSON","parse","get","e","data_store","datastore","ghc_study","slideId","slideName","specimen","mpp","mpp_x","mpp_y","ghc","addEventListener","name","url","call","loadInstancesInStudy"],"mappings":"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","file":"ghc_package.map","sourceRoot":"../package","sourcesContent":[" class GHCHelpers {\n   // adatped from https://github.com/GoogleCloudPlatform/dicomweb-wsi-viewer/blob/master/viewer.js\n   constructor(project, location, dataset, store, viewer){\n     this.viewer = viewer\n     // required params\n     this.project = project\n     this.location = location;\n     this.dataset = dataset;\n     this.store = store;\n     // dicom standar attribute tags\n     this.COLUMN_POSITION_TAG = '0048021E';\n     this.COLUMNS_TAG = '00280011';  // Number of columns in the image\n     // Per-frame Functional Groups Sequence\n     this.FUNCTIONAL_GROUP_SEQUENCE_TAG = '52009230';\n     this.PLANE_POSITION_SEQUENCE_TAG = '0048021A';  // Plane Position Sequence\n     this.ROW_POSITION_TAG = '0048021F';\n     this.ROWS_TAG = '00280010';  // Number of rows in the image\n     this.SERIES_INSTANCE_UID_TAG = '0020000E';\n     this.SOP_INSTANCE_UID_TAG = '00080018';\n     // Unique identifier for the Series that is part of the Study\n     this.STUDY_INSTANCE_UID_TAG = '0020000D';\n     // Total number of columns in pixel matrix\n     this.TOTAL_PIXEL_MATRIX_COLUMNS_TAG = '00480006';\n     // Total number of rows in pixel matrix\n     this.TOTAL_PIXEL_MATRIX_ROWS_TAG = '00480007';\n     // google url, may change??\n     this.updatedDicomUrl = 'https://healthcare.googleapis.com/v1beta1/projects/'\n     // token stuff\n     var cookiename = \"GHCToken\"\n     var cookiestring=RegExp(\"\"+cookiename+\"[^;]+\").exec(document.cookie);\n     this.token = decodeURIComponent(!!cookiestring ? cookiestring.toString().replace(/^[^=]+./,\"\") : \"\");\n   }\n\n   toDicomWebQIDOUrl(path) {\n     return this.updatedDicomUrl + path + '?includefield=all&access_token=' + this.token;\n\n   }\n   toDicomWebWADOUrl(path) {\n     return this.updatedDicomUrl + path + '?access_token=' + this.token;\n   }\n   loadInstancesInStudy(study) {\n     var baseUrl = this.project + \"/locations/\"+ this.location +\"/datasets/\" + this.dataset + \"/dicomStores/\" + this.store + \"/dicomWeb/studies/\"\n     const pathToStudy = baseUrl + study\n     const seriesPath = pathToStudy + '/series';\n     $.ajax({\n       url: this.toDicomWebQIDOUrl(seriesPath),\n       error: function(jqXHR) {\n         alert(\n             'Error - retrieving series failed: ' +\n             jqXHR.responseJSON[0].error.code + ' ' +\n             jqXHR.responseJSON[0].error.message);\n       },\n       success: function(series) {\n         const instancesPath = seriesPath + '/' +\n             series[0][this.SERIES_INSTANCE_UID_TAG].Value[0] + '/instances';\n         $.ajax({\n           url: this.toDicomWebQIDOUrl(instancesPath),\n           error: function(jqXHR) {\n             alert(\n                 'Error - retrieving instances failed: ' +\n                 jqXHR.responseJSON[0].error.code + ' ' +\n                 jqXHR.responseJSON[0].error.message);\n           },\n           success: function(instances) {\n             try {\n               let maxWidthPx = 0;\n               let maxHeightPx = 0;\n               let tileWidthPx = 0;\n               let tileHeightPx = 0;\n               let levelWidths = new Set();\n\n               for (let i = 0; i < instances.length; i++) {\n                 const w =\n                     Number(instances[i][this.TOTAL_PIXEL_MATRIX_COLUMNS_TAG].Value);\n                 levelWidths.add(w);\n                 const h = Number(instances[i][this.TOTAL_PIXEL_MATRIX_ROWS_TAG].Value);\n\n                 if (w > maxWidthPx) {\n                   maxWidthPx = w;\n                 }\n                 if (h > maxHeightPx) {\n                   maxHeightPx = h;\n                 }\n                 tileWidthPx = Number(instances[i][this.COLUMNS_TAG].Value);\n                 tileHeightPx = Number(instances[i][this.ROWS_TAG].Value);\n               }\n               const sortedLevelWidths = Array.from(levelWidths.values());\n               sortedLevelWidths.sort((a, b) => b - a);\n\n               const countLevels = levelWidths.size;\n               // Compute pyramid cache\n               // Map of \"x,y,z\" => {SOPInstanceUID, Frame No.}\n               const pyramidMeta =this.calculatePyramidMeta(instances, sortedLevelWidths);\n\n               var tileSource = {\n                 height: maxHeightPx,\n                 width: maxWidthPx,\n                 tileSize: tileWidthPx,\n                 maxLevel: countLevels - 1,\n                 minLevel: 0,\n                 getTileUrl: function(level, row, col) {\n                   const x = 1 + (tileWidthPx * row);\n                   const y = 1 + (tileHeightPx * col);\n                   const z = countLevels - 1 - level;\n                   const key = x + '/' + y + '/' + z;\n                   const params = pyramidMeta[key];\n                   return this.toDicomWebWADOUrl(\n                       instancesPath + '/' + params.SOPInstanceUID + '/frames/' +\n                       params.FrameNumber + '/rendered');\n                 }.bind(this),\n                 getLevelScale: function(level) {\n                   return sortedLevelWidths[countLevels - 1 - level] / maxWidthPx;\n                 }\n               };\n               var ts_event = new CustomEvent('ghc_tileSource_ready', { detail: tileSource });\n               document.dispatchEvent(ts_event);\n               console.log(tileSource)\n               this.viewer.open(tileSource)\n             } catch (err) {\n               console.error(err)\n               alert(\n                   `Could not parse DICOM for study, possible reason: DICOM is not\n                   pathology or damaged image.`);\n             }\n           }.bind(this)\n         });\n       }.bind(this)\n     });\n   }\n   calculatePyramidMeta(dicomInstances, sortedLevelWidths) {\n     let widthToLevelMap = {};\n     for (let i = 0; i < sortedLevelWidths.length; i++) {\n       widthToLevelMap[sortedLevelWidths[i]] = i;\n     }\n\n     let pyramidMeta = {};\n     for (let i = 0; i < dicomInstances.length; i++) {\n       const sopInstanceUID = dicomInstances[i][this.SOP_INSTANCE_UID_TAG].Value;\n       const frameMeta = dicomInstances[i][this.FUNCTIONAL_GROUP_SEQUENCE_TAG].Value;\n\n       for (let j = 0; j < frameMeta.length; j++) {\n         const frameNumber = j + 1;\n\n         // For (x,y) should actually use\n         // FrameContentSequence.DimensionIndexValues which an array of\n         // size 2 with [x, y]. The below are pixel values and need to be\n         // diveded by frameWidth/frameHeight.\n         // PerFrameFunctionalGroupsSequence.PlanePositionSlideSequence.ColumnPositionInTotalImagePixelMatrix\n         const x = frameMeta[j][this.PLANE_POSITION_SEQUENCE_TAG]\n                       .Value[0][this.COLUMN_POSITION_TAG]\n                       .Value;\n         // PerFrameFunctionalGroupsSequence.PlanePositionSlideSequence.RowPositionInTotalImagePixelMatrix\n         const y = frameMeta[j][this.PLANE_POSITION_SEQUENCE_TAG]\n                       .Value[0][this.ROW_POSITION_TAG]\n                       .Value;\n\n         const w = Number(dicomInstances[i][this.TOTAL_PIXEL_MATRIX_COLUMNS_TAG].Value);\n         const z = sortedLevelWidths.indexOf(w);\n\n         const key = x + '/' + y + '/' + z;\n         pyramidMeta[key] = {\n           'SOPInstanceUID': sopInstanceUID,\n           'FrameNumber': frameNumber,\n         };\n       }\n     }\n     return pyramidMeta;\n   }\n }\n\n\nexport default GHCHelpers\n","import GHCHelpers from './GHCHelpers.js'\n// this is not working yet. WIP until I can look at the data\nCaMic.prototype.loadImg = function(func) {\n  // do we have a GHC token?\n  // load up!\n  var urlParams = new URLSearchParams(window.location.search);\n  let default_project = \"public-datasets-194701\"\n  let default_location = \"us-central1\"\n  let default_data_store = \"test1\"\n  let default_dataset = \"rbirmin_dicom_test\"\n  let default_ghc_study = \"1.2.276.0.7230010.3.1.2.1784940379.231387.1533066220.970617\"\n  var ghc_params = {}\n  try{\n    ghc_params = JSON.parse(decodeURIComponent(urlParams.get('slideId'))) || {}\n  } catch (e){\n    console.log(\"bad or missing ghc param object\", e)\n  }\n  this.project = ghc_params.project || default_project\n  this.location = ghc_params.location || default_location\n  this.data_store = ghc_params.datastore || default_data_store\n  this.dataset = ghc_params.dataset || default_dataset\n  this.ghc_study = ghc_params.study || default_ghc_study // the thing we expect to change\n  var img_id = urlParams.get('slideId');\n  this.slideId = \"GHC:\" + this.project + \":\" + this.location + \":\" + this.data_store + \":\"+ this.dataset + \":\" + this.ghc_study\n  this.slideName = \"GHC IMG FROM \" + this.project\n  this.study = \"\"\n  this.specimen = \"\"\n  this.mpp = 1e9;\n  this.mpp_x = this.mpp; // until we can fix this\n  this.mpp_y = this.mpp;\n  var ghc = new GHCHelpers(this.project, this.location, this.dataset, this.data_store, this.viewer)\n  document.addEventListener(\"ghc_tileSource_ready\", e=>{\n    console.log(\"finishing load with event\")\n    // create item to pass to the callback function, previously x[0] (slide data)\n    let x = {}\n    x['_id'] = this.slideId\n    x.name = this.slideName\n\n    x.study = this.study\n    x.specimen = this.specimen\n    x.mpp = this.mpp;\n    x.mpp_x = this.mpp_x;\n    x.mpp_y = this.mpp_y;\n    x.location = \"GHC--\" + this.slideId\n    x.url = e.tileSource; // oh no, the secondary viewers...\n    if (func && typeof func === 'function') {\n      func.call(null, x);\n    }\n  })\n  ghc.loadInstancesInStudy(this.ghc_study) // opens viewer to its own custom source\n\n\n}\n"]}